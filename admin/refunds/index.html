<!DOCTYPE html>
<html lang="ru">

<head>
    <!-- Redesigned with Tailwind CSS -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>–í–æ–∑–≤—Ä–∞—Ç—ã - Admin Panel</title>
    <script src="/assets/js/tailwind-config.js?v=999.1"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="../../assets/js/core/unified-alerts.js?v=1000"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../../assets/css/alerts.css?v=1">
    <style type="text/tailwindcss">
        @layer utilities {
            .transition-transform {
                transition-property: transform;
                transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                transition-duration: 150ms;
            }
        }
    </style>
</head>

<body>
    <div class="min-h-screen bg-gray-50">
        <div class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between max-w-7xl mx-auto">
                <div class="flex items-center space-x-4">
                    <h1 class="text-xl font-bold text-gray-900">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–æ–∑–≤—Ä–∞—Ç–∞–º–∏</h1>
                </div>
                <div>
                    <a href="/admin" class="inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg transition-colors">
                        <i class="fas fa-home mr-2"></i>
                        –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
                    </a>
                </div>
            </div>
        </div>

        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Statistics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-xl p-6 text-white shadow-lg">
                    <h3 class="text-lg font-semibold mb-2">‚è≥ –û–∂–∏–¥–∞—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</h3>
                    <div class="text-3xl font-bold mb-2" id="statRequested">0</div>
                    <div class="text-sm opacity-90">–¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è</div>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-6 text-white shadow-lg">
                    <h3 class="text-lg font-semibold mb-2">‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ</h3>
                    <div class="text-3xl font-bold mb-2" id="statApproved">0</div>
                    <div class="text-sm opacity-90">–£—Å–ø–µ—à–Ω—ã—Ö –≤–æ–∑–≤—Ä–∞—Ç–æ–≤</div>
                </div>
                <div class="bg-gradient-to-br from-red-500 to-pink-600 rounded-xl p-6 text-white shadow-lg">
                    <h3 class="text-lg font-semibold mb-2">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</h3>
                    <div class="text-3xl font-bold mb-2" id="statRejected">0</div>
                    <div class="text-sm opacity-90">–û—Ç–∫–∞–∑–æ–≤</div>
                </div>
                <div class="bg-gradient-to-br from-purple-600 to-indigo-600 rounded-xl p-6 text-white shadow-lg">
                    <h3 class="text-lg font-semibold mb-2">üíµ –û–±—â–∞—è —Å—É–º–º–∞</h3>
                    <div class="text-3xl font-bold mb-2" id="statTotal">$0</div>
                    <div class="text-sm opacity-90">–í–æ–∑–≤—Ä–∞—â–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç–∞–º</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-8 border border-gray-100">
                <div class="flex flex-wrap gap-4 items-center">
                    <label class="text-sm font-medium text-gray-700">–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É:</label>
                    <select id="statusFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white" onchange="loadRefunds()">
                        <option value="">–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã</option>
                        <option value="requested" selected>‚è≥ –û–∂–∏–¥–∞—é—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</option>
                        <option value="approved">‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ</option>
                        <option value="rejected">‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
                        <option value="completed">üéâ –ó–∞–≤–µ—Ä—à–µ–Ω–æ</option>
                    </select>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12" style="display: none;">
                <i class="fas fa-spinner fa-spin text-4xl text-purple-600 mb-4"></i>
                <p class="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤...</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="text-center py-16 px-8" style="display: none;">
                <svg class="w-24 h-24 mx-auto mb-4 text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                    <line x1="9" y1="9" x2="9.01" y2="9"></line>
                    <line x1="15" y1="9" x2="15.01" y2="9"></line>
                </svg>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">–ó–∞–ø—Ä–æ—Å–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                <p class="text-gray-500">–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç</p>
            </div>

            <!-- Refunds Container -->
            <div class="grid grid-cols-1 gap-6" id="refundsContainer">
            </div>
        </div>
    </div>

    <!-- Approve Modal -->
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="approveModal">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full mx-4">
            <div class="border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç</h2>
                <button class="text-gray-400 hover:text-gray-600 text-2xl w-8 h-8 flex items-center justify-center" onclick="closeModal('approveModal')">&times;</button>
            </div>
            <div class="px-6 py-4">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <textarea id="approveNotes" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 min-h-[100px]" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..."></textarea>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                <button class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors" onclick="closeModal('approveModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors" onclick="confirmApprove()">–û–¥–æ–±—Ä–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç</button>
            </div>
        </div>
    </div>

    <!-- Reject Modal -->
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden" id="rejectModal">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full mx-4">
            <div class="border-b border-gray-200 px-6 py-4 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-900">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å –≤–æ–∑–≤—Ä–∞—Ç</h2>
                <button class="text-gray-400 hover:text-gray-600 text-2xl w-8 h-8 flex items-center justify-center" onclick="closeModal('rejectModal')">&times;</button>
            </div>
            <div class="px-6 py-4">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è *</label>
                    <textarea id="rejectNotes" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 min-h-[100px]" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è..." required></textarea>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                <button class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition-colors" onclick="closeModal('rejectModal')">–û—Ç–º–µ–Ω–∞</button>
                <button class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors" onclick="confirmReject()">–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å</button>
            </div>
        </div>
    </div>

    <script defer src="../../assets/js/core/auth.js?v=999"></script>
    <script src="../../assets/js/core/router.js"></script>
    <script src="../../assets/js/core/config.js?v=999"></script>
    <script defer src="../../assets/js/core/websocket.js?v=999"></script>
    <script defer src="../../assets/js/core/notifications.js?v=999"></script>
    <script defer src="../../assets/js/shared/lazy-loader.js?v=999"></script>
    <script defer src="../../assets/js/core/cache.js?v=999"></script>
    <script defer src="../../assets/js/shared/common-utils.js?v=999"></script>
    <script>
        let refunds = [];
        let currentRefundId = null;
        let ws = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadRefunds();
            connectWebSocket();
        });

        async function loadRefunds() {
            const token = localStorage.getItem('token');
            const status = document.getElementById('statusFilter').value;

            showLoading();

            try {
                const params = new URLSearchParams();
                if (status) params.append('status', status);

                const response = await fetch(`${API_URL}/api/v1/admin/refunds?${params}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (!response.ok) throw new Error('Failed to load refunds');

                refunds = await response.json();
                renderRefunds();
                updateStatistics();
            } catch (error) {
                console.error('Failed to load refunds:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç');
                showEmpty();
            }
        }

        function renderRefunds() {
            const container = document.getElementById('refundsContainer');
            container.innerHTML = '';

            hideLoading();

            if (!refunds || refunds.length === 0) {
                showEmpty();
                return;
            }

            document.getElementById('emptyState').style.display = 'none';

            refunds.forEach(refund => {
                const card = createRefundCard(refund);
                container.appendChild(card);
            });
        }

        function createRefundCard(refund) {
            const card = document.createElement('div');
            card.className = 'bg-white rounded-xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow';

            const showActions = refund.status === 'requested';
            const statusConfig = {
                'requested': { text: '‚è≥ –û–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏', class: 'bg-yellow-100 text-yellow-800' },
                'approved': { text: '‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ', class: 'bg-green-100 text-green-800' },
                'rejected': { text: '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ', class: 'bg-red-100 text-red-800' },
                'completed': { text: 'üéâ –ó–∞–≤–µ—Ä—à–µ–Ω–æ', class: 'bg-blue-100 text-blue-800' }
            };
            const status = statusConfig[refund.status] || statusConfig['requested'];

            card.innerHTML = `
                <div class="flex justify-between items-start mb-6">
                    <span class="text-lg font-semibold text-gray-900">–í–æ–∑–≤—Ä–∞—Ç #${refund.id}</span>
                    <span class="${status.class} px-3 py-1 rounded-full text-sm font-medium">${status.text}</span>
                </div>
                <div class="space-y-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <span class="text-sm text-gray-500 block mb-1">–ó–∞–∫–∞–∑</span>
                            <span class="text-base font-medium text-gray-900">#${refund.order_number || refund.order_id}</span>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500 block mb-1">–°—É–º–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞</span>
                            <span class="text-base font-bold text-green-600">$${parseFloat(refund.amount).toFixed(2)}</span>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500 block mb-1">–î–∞—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞</span>
                            <span class="text-base font-medium text-gray-900">${formatDate(refund.created_at)}</span>
                        </div>
                        ${refund.processed_at ? `
                            <div>
                                <span class="text-sm text-gray-500 block mb-1">–î–∞—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏</span>
                                <span class="text-base font-medium text-gray-900">${formatDate(refund.processed_at)}</span>
                            </div>
                        ` : ''}
                    </div>
                    ${refund.reason ? `
                        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">–ü—Ä–∏—á–∏–Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞:</h4>
                            <p class="text-sm text-gray-600">${refund.reason}</p>
                        </div>
                    ` : ''}
                    ${refund.admin_notes ? `
                        <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                            <h4 class="text-sm font-semibold text-purple-700 mb-2">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</h4>
                            <p class="text-sm text-purple-600">${refund.admin_notes}</p>
                        </div>
                    ` : ''}
                </div>
                ${showActions ? `
                    <div class="flex gap-3 pt-4 border-t border-gray-200">
                        <button class="flex-1 px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors" onclick="approveRefund(${refund.id})">
                            ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å
                        </button>
                        <button class="flex-1 px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors" onclick="rejectRefund(${refund.id})">
                            ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                        </button>
                    </div>
                ` : ''}
            `;

            return card;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function approveRefund(refundId) {
            currentRefundId = refundId;
            document.getElementById('approveNotes').value = '';
            document.getElementById('approveModal').classList.add('show');
        }

        function rejectRefund(refundId) {
            currentRefundId = refundId;
            document.getElementById('rejectNotes').value = '';
            document.getElementById('rejectModal').classList.add('show');
        }

        async function confirmApprove() {
            const notes = document.getElementById('approveNotes').value;
            await processRefund('approve', notes);
        }

        async function confirmReject() {
            const notes = document.getElementById('rejectNotes').value;
            
            if (!notes.trim()) {
                showError('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è');
                return;
            }

            await processRefund('reject', notes);
        }

        async function processRefund(action, adminNotes) {
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_URL}/api/v1/admin/refunds/${currentRefundId}/process`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action,
                        admin_notes: adminNotes
                    })
                });

                if (!response.ok) throw new Error('Failed to process refund');

                const result = await response.json();
                showSuccess(result.message);
                
                closeModal('approveModal');
                closeModal('rejectModal');
                
                await loadRefunds();
            } catch (error) {
                console.error('Failed to process refund:', error);
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            currentRefundId = null;
        }

        function updateStatistics() {
            const stats = {
                requested: 0,
                approved: 0,
                rejected: 0,
                totalAmount: 0
            };

            refunds.forEach(refund => {
                if (refund.status === 'requested') stats.requested++;
                if (refund.status === 'approved' || refund.status === 'completed') {
                    stats.approved++;
                    stats.totalAmount += parseFloat(refund.amount);
                }
                if (refund.status === 'rejected') stats.rejected++;
            });

            document.getElementById('statRequested').textContent = stats.requested;
            document.getElementById('statApproved').textContent = stats.approved;
            document.getElementById('statRejected').textContent = stats.rejected;
            document.getElementById('statTotal').textContent = `$${stats.totalAmount.toFixed(2)}`;
        }

        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('refundsContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('refundsContainer').style.display = 'grid';
        }

        function showEmpty() {
            hideLoading();
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('refundsContainer').style.display = 'none';
        }

        function showSuccess(message) {
            showAlert(message, 'success');
        }

        function showError(message) {
            showAlert(message, 'error');
        }

        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);

            setTimeout(() => alert.remove(), 5000);
        }

        function connectWebSocket() {
            const token = localStorage.getItem('token');
            const wsUrl = `${WS_URL}?token=${token}&client_type=admin`;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('WebSocket message error:', error);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                setTimeout(connectWebSocket, 5000);
            };
        }

        function handleWebSocketMessage(data) {
            if (data.event === 'refund.requested') {
                showSuccess(`üîî –ù–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç: –∑–∞–∫–∞–∑ #${data.order_number}`);
                playNotificationSound();
                loadRefunds();
            }

            if (data.event === 'refund.processed') {
                loadRefunds();
            }
        }

        function playNotificationSound() {
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZSA0PVKzn77BdGAg+ltryxnMlBSuBzvLZiTYIG2m98KKbMAcsPJ/Z');
                audio.play().catch(() => {});
            } catch (error) {
                }
        }

        // Close modals on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal('approveModal');
                closeModal('rejectModal');
            }
        });

        // Close modals on outside click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal(modal.id);
                }
            });
        });
    </script>
    <script defer src="../../assets/js/shared/navigation.js?v=1001"></script>
</body>

</html>
