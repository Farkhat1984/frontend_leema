<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Авторизация...</title>
    <script src="/assets/js/tailwind-config.js?v=1003.1"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }
    </style>
</head>

<body class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600">
    <div class="text-center text-white">
        <div class="spinner w-12 h-12 border-4 border-white/30 border-t-white rounded-full mx-auto mb-5"></div>
        <p class="text-lg">Завершаем авторизацию...</p>
    </div>

    <script src="../../assets/js/core/router.js?v=1004"></script>
    <script src="../../assets/js/core/config.js?v=1003"></script>
    <script>

        async function handleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');

            if (!code) {
                showError('Отсутствует код авторизации');
                return;
            }

            try {
                // Проверяем что API_URL загружен
                if (typeof API_URL === 'undefined') {
                    showError('Ошибка загрузки конфигурации. Пожалуйста, обновите страницу.');
                    return;
                }

                // Получаем запрошенный тип аккаунта
                const requestedType = localStorage.getItem('requestedAccountType') || 'user';
                
                // Для API: admin -> user, shop -> shop
                const accountType = requestedType === 'admin' ? 'user' : requestedType;
// Авторизуемся в бэкенде
                const response = await fetch(`${API_URL}/api/v1/auth/google/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: code,
                        account_type: accountType,
                        platform: 'web'
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: 'Ошибка авторизации' }));
                    throw new Error(errorData.detail || 'Ошибка авторизации');
                }

                const data = await response.json();
                
                // Сохраняем токены
                localStorage.setItem('token', data.access_token);
                localStorage.setItem('refresh_token', data.refresh_token);
                
                // Сохраняем platform из ответа
                const platformValue = data.platform || 'web';
                localStorage.setItem('platform', platformValue);

                // Сохраняем данные пользователя/магазина
                let finalAccountType = 'user';
                let redirectPath = Router.paths.user.dashboard;
                
                if (data.user) {
                    localStorage.setItem('user', JSON.stringify(data.user));
                    localStorage.setItem('userData', JSON.stringify(data.user));
                    localStorage.setItem('userRole', data.user.role);
                    
                    // Определяем accountType на основе роли пользователя
                    // Если роль admin - accountType всегда admin, независимо от запроса
                    if (data.user.role === 'admin') {
                        finalAccountType = 'admin';
                        redirectPath = Router.paths.admin.dashboard;
                    } else if (data.user.role === 'shop_owner') {
                        finalAccountType = 'shop';
                        redirectPath = Router.paths.shop.dashboard;
                    } else {
                        finalAccountType = 'user';
                        redirectPath = Router.paths.user.dashboard;
                    }
                    
                    localStorage.setItem('accountType', finalAccountType);
                    localStorage.setItem('account_type', finalAccountType);
                } else if (data.shop) {
                    localStorage.setItem('shop', JSON.stringify(data.shop));
                    localStorage.setItem('userData', JSON.stringify(data.shop));
                    localStorage.setItem('userRole', 'shop_owner');
                    localStorage.setItem('accountType', 'shop');
                    localStorage.setItem('account_type', 'shop');
                    finalAccountType = 'shop';
                    redirectPath = Router.paths.shop.dashboard;
                }

                // Очистка
                localStorage.removeItem('requestedAccountType');

                // Проверка прав доступа
                if (requestedType === 'admin' && finalAccountType !== 'admin') {
                    showError('У вас нет прав администратора. Попробуйте войти как пользователь.');
                    return;
                }
                
                // Redirect на правильную страницу в зависимости от роли
                Router.navigate(redirectPath, true);
            } catch (error) {
showError(error.message);
            }
        }

        function showError(message) {
            document.body.innerHTML = `
                <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 p-4">
                    <div class="bg-white p-8 rounded-2xl text-red-600 max-w-lg">
                        <h2 class="text-2xl font-bold mb-4">Ошибка авторизации</h2>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <button onclick="window.location.href='/public'" 
                            class="mt-5 px-5 py-2.5 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-colors cursor-pointer text-base">
                            Вернуться
                        </button>
                    </div>
                </div>
            `;
        }

        // Start authentication
        handleCallback();
    </script>
</body>

</html>